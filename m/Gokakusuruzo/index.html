<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>åˆæ ¼ã‚’æ›¸ã„ã¦ç«¶ãŠã†</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  overflow: hidden;
  font-family: sans-serif;
  background: #f5f5f5;
  text-align: center;
}
canvas, img {
  width: 300px;
  height: 300px;
  background: #fff;
  border: 2px solid #000;
}
canvas {
  touch-action: none;
}
.row {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin: 10px 0;
}
.hidden { display: none; }
button, select, input {
  font-size: 16px;
  padding: 6px;
  margin: 4px;
}
#result {
  font-size: 20px;
  font-weight: bold;
  margin-top: 10px;
}
</style>
</head>

<body>

<h1>ã€Œåˆæ ¼ã€ã‚’æ›¸ã„ã¦ç«¶ãŠã†</h1>

<div>
  ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼š
  <input id="nickname" maxlength="10" placeholder="10æ–‡å­—ä»¥å†…">
</div>

<div>
  é›£æ˜“åº¦ï¼š
  <select id="difficulty">
    <option value="easy">EASY</option>
    <option value="normal" selected>NORMAL</option>
    <option value="hard">HARD</option>
  </select>
</div>

<!-- STEP1 -->
<div id="step1">
  <p>ãŠæ‰‹æœ¬ã‚’ã‚ˆãè¦‹ã¦è¦šãˆã¦ãã ã•ã„</p>
  <div class="row">
    <img src="model_go.png">
    <img src="model_kaku.png">
  </div>
  <button onclick="toStep2()">æ›¸ã</button>
</div>

<!-- STEP2 -->
<div id="step2" class="hidden">
  <p>ãŠæ‰‹æœ¬ã‚’è¦‹ãšã«æ›¸ã„ã¦ãã ã•ã„</p>
  <div class="row">
    <canvas id="go" width="300" height="300"></canvas>
    <canvas id="kaku" width="300" height="300"></canvas>
  </div>
  <button onclick="judge()">åˆ¤å®š</button>
  <button onclick="resetCanvas()">ãƒªã‚»ãƒƒãƒˆ</button>
</div>

<div id="result"></div>

<h2>ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚° TOP10</h2>
<ul id="ranking"></ul>

<script>
/* ========= Firebase è¨­å®šï¼ˆè‡ªåˆ†ã®ã‚‚ã®ã«å·®ã—æ›¿ãˆï¼‰ ========= */
firebase.initializeApp({
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_DOMAIN",
  projectId: "YOUR_PROJECT_ID"
});
const db = firebase.firestore();

/* ========= Canvas æç”» ========= */
function setupCanvas(canvas) {
  const ctx = canvas.getContext("2d");
  ctx.lineWidth = 6;
  ctx.lineCap = "round";
  ctx.strokeStyle = "#000";
  let drawing = false;

  function getPos(e) {
    const r = canvas.getBoundingClientRect();
    if (e.touches) {
      return {
        x: e.touches[0].clientX - r.left,
        y: e.touches[0].clientY - r.top
      };
    }
    return { x: e.offsetX, y: e.offsetY };
  }

  function start(e) {
    e.preventDefault();
    drawing = true;
    const p = getPos(e);
    ctx.beginPath();
    ctx.moveTo(p.x, p.y);
  }
  function move(e) {
    e.preventDefault();
    if (!drawing) return;
    const p = getPos(e);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
  }
  function end(e) {
    e.preventDefault();
    drawing = false;
  }

  canvas.addEventListener("mousedown", start);
  canvas.addEventListener("mousemove", move);
  canvas.addEventListener("mouseup", end);
  canvas.addEventListener("mouseleave", end);
  canvas.addEventListener("touchstart", start, { passive:false });
  canvas.addEventListener("touchmove", move, { passive:false });
  canvas.addEventListener("touchend", end, { passive:false });

  return ctx;
}

const goCtx = setupCanvas(document.getElementById("go"));
const kakuCtx = setupCanvas(document.getElementById("kaku"));

/* ========= é›£æ˜“åº¦è¨­å®š ========= */
function getDifficulty() {
  const d = difficulty.value;
  if (d === "easy") return { overflow:30, thick:2.0, thickP:20 };
  if (d === "hard") return { overflow:60, thick:1.5, thickP:40 };
  return { overflow:40, thick:1.8, thickP:30 }; // normal
}

/* ========= æ¡ç‚¹ ========= */
function normalize(img) {
  for (let i=0;i<img.data.length;i+=4) {
    const v = img.data[i];
    const bw = v < 200 ? 0 : 255;
    img.data[i]=img.data[i+1]=img.data[i+2]=bw;
  }
  return img;
}

function calcScore(ctx, modelSrc, cb) {
  const user = normalize(ctx.getImageData(0,0,300,300));
  const img = new Image();
  img.onload = () => {
    const c = document.createElement("canvas");
    c.width = c.height = 300;
    const t = c.getContext("2d");
    t.drawImage(img,0,0,300,300);
    const model = normalize(t.getImageData(0,0,300,300));

    let hit=0, miss=0, mc=0, uc=0;
    for (let i=0;i<model.data.length;i+=4) {
      const m = model.data[i]===0;
      const u = user.data[i]===0;
      if (m) mc++;
      if (u) uc++;
      if (m&&u) hit++;
      if (!m&&u) miss++;
    }

    const s = getDifficulty();
    let score =
      hit/mc*100
      - miss/mc*s.overflow
      - Math.max(0, uc/mc - s.thick) * s.thickP;

    cb(Math.max(0,Math.min(100,Math.floor(score))));
  };
  img.src = modelSrc;
}

/* ========= åˆ¤å®š ========= */
function judge() {
  const name = nickname.value.trim();
  if (!name) return alert("ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

  calcScore(goCtx,"model_go.png",go=>{
    calcScore(kakuCtx,"model_kaku.png",ka=>{
      const avg = Math.floor((go+ka)/2);
      const rank = avg>=95?"S":avg>=80?"A":avg>=65?"B":"C";

      result.innerHTML =
        `åˆ:${go}%ã€€æ ¼:${ka}%<br>å¹³å‡:${avg}%ã€€ãƒ©ãƒ³ã‚¯:${rank}`;

      db.collection("scores").add({
        name, score:avg, rank,
        time: firebase.firestore.FieldValue.serverTimestamp()
      });
    });
  });
}

/* ========= ãƒ©ãƒ³ã‚­ãƒ³ã‚° ========= */
db.collection("scores")
  .orderBy("score","desc")
  .limit(10)
  .onSnapshot(s=>{
    ranking.innerHTML="";
    s.forEach(d=>{
      const x=d.data();
      const li=document.createElement("li");
      li.textContent=`${x.name}ï¼š${x.score}%ï¼ˆ${x.rank}ï¼‰`;
      ranking.appendChild(li);
    });
  });

function toStep2(){
  step1.classList.add("hidden");
  step2.classList.remove("hidden");
}
function resetCanvas(){
  goCtx.clearRect(0,0,300,300);
  kakuCtx.clearRect(0,0,300,300);
}
</script>

</body>
</html>
