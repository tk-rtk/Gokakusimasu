<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>合格チャレンジ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
html,body{margin:0;overflow:hidden;font-family:sans-serif;text-align:center;}
canvas,img{width:300px;height:300px;border:2px solid #000;background:#fff;}
canvas{touch-action:none;}
.row{display:flex;justify-content:center;gap:10px;}
.hidden{display:none;}
</style>
</head>
<body>

<h2>「合格」を書こう</h2>

<select id="difficulty">
  <option value="easy">EASY</option>
  <option value="normal" selected>NORMAL</option>
  <option value="hard">HARD</option>
</select>

<div id="step1">
  <div class="row">
    <img src="model_go.png">
    <img src="model_kaku.png">
  </div>
  <button onclick="start()">書く</button>
</div>

<div id="step2" class="hidden">
  <div class="row">
    <canvas id="go" width="300" height="300"></canvas>
    <canvas id="kaku" width="300" height="300"></canvas>
  </div>
  <button onclick="judge()">判定</button>
</div>

<div id="result"></div>

<script>
function setup(c){
  const ctx=c.getContext("2d");
  ctx.lineWidth=8;
  ctx.lineCap="round";
  let d=false;

  function p(e){
    const r=c.getBoundingClientRect();
    const t=e.touches?e.touches[0]:e;
    return {x:t.clientX-r.left,y:t.clientY-r.top};
  }

  function s(e){e.preventDefault();d=true;const q=p(e);ctx.beginPath();ctx.moveTo(q.x,q.y);}
  function m(e){e.preventDefault();if(!d)return;const q=p(e);ctx.lineTo(q.x,q.y);ctx.stroke();}
  function e(e){e.preventDefault();d=false;}

  c.addEventListener("mousedown",s);
  c.addEventListener("mousemove",m);
  c.addEventListener("mouseup",e);
  c.addEventListener("touchstart",s,{passive:false});
  c.addEventListener("touchmove",m,{passive:false});
  c.addEventListener("touchend",e,{passive:false});

  return ctx;
}

const goCtx=setup(go);
const kaCtx=setup(kaku);

function radius(){
  return difficulty.value==="easy"?6:
         difficulty.value==="hard"?2:4;
}

function ink(img){
  let c=0;
  for(let i=0;i<img.data.length;i+=4){
    if(img.data[i]<200) c++;
  }
  return c;
}

function score(ctx,src,cb){
  const u=ctx.getImageData(0,0,300,300);
  if(ink(u)<400){ cb(0); return; } // ★最重要

  const img=new Image();
  img.onload=()=>{
    const c=document.createElement("canvas");
    c.width=c.height=300;
    const t=c.getContext("2d");
    t.drawImage(img,0,0,300,300);
    const m=t.getImageData(0,0,300,300);

    let hit=0,total=0;
    const r=radius();

    for(let y=0;y<300;y+=2){
      for(let x=0;x<300;x+=2){
        const i=(y*300+x)*4;
        if(m.data[i]<200){
          total++;
          let ok=false;
          for(let dy=-r;dy<=r&&!ok;dy++){
            for(let dx=-r;dx<=r;dx++){
              const nx=x+dx,ny=y+dy;
              if(nx<0||ny<0||nx>=300||ny>=300)continue;
              const ni=(ny*300+nx)*4;
              if(u.data[ni]<200){ok=true;break;}
            }
          }
          if(ok) hit++;
        }
      }
    }
    cb(Math.floor(hit/total*100));
  };
  img.src=src;
}

function judge(){
  score(goCtx,"model_go.png",a=>{
    score(kaCtx,"model_kaku.png",b=>{
      const avg=Math.floor((a+b)/2);
      const rank=avg>=95?"S":avg>=80?"A":avg>=65?"B":"C";
      result.innerHTML=`合:${a}% 格:${b}%<br>平均:${avg}% ランク:${rank}`;
    });
  });
}

function start(){
  step1.classList.add("hidden");
  step2.classList.remove("hidden");
}
</script>
</body>
</html>
