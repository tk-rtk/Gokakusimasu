<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>åˆæ ¼ã‚’æ›¸ã„ã¦ã¿ã‚ˆã†</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<!-- Firebase SDKï¼ˆscriptã‚¿ã‚°æ–¹å¼ï¼‰ -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  overflow: hidden;
  font-family: sans-serif;
  text-align: center;
}
canvas {
  border: 2px solid black;
  touch-action: none;
}
</style>
</head>

<body>

<h1>ã€Œåˆæ ¼ã€ã‚’æ›¸ã„ã¦ã¿ã‚ˆã†ï¼</h1>

<div>
  ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼š
  <input id="nickname" maxlength="10" placeholder="10æ–‡å­—ä»¥å†…">
</div>

<canvas id="go" width="300" height="300"></canvas>
<br>
<button onclick="judge()">åˆ¤å®š</button>

<h2>ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
<ul id="ranking"></ul>

<script>
/* =====================
   Firebase åˆæœŸåŒ–
===================== */

const firebaseConfig = {
  apiKey: "AIzaSyDuvDzmbIigTcXYqxN1dkLDg793sUy3src",
  authDomain: "go-kaku.firebaseapp.com",
  projectId: "go-kaku",
  storageBucket: "go-kaku.firebasestorage.app",
  messagingSenderId: "373881843090",
  appId: "1:373881843090:web:d30e6265d809034e62654b",
  measurementId: "G-RWSGKGVCQY"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* =====================
   ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å–å¾—
===================== */
function getNickname() {
  let name = localStorage.getItem("nickname");
  if (!name) {
    name = document.getElementById("nickname").value.trim();
    if (!name) {
      alert("ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      throw new Error("no name");
    }
    localStorage.setItem("nickname", name);
  }
  return name;
}

/* =====================
   ä»®ã®ã‚¹ã‚³ã‚¢é€ä¿¡
===================== */
function judge() {
  const score = Math.floor(Math.random() * 40) + 60; // ãƒ†ã‚¹ãƒˆç”¨
  const rank = score >= 95 ? "S" :
               score >= 80 ? "A" :
               score >= 65 ? "B" : "C";

  const name = getNickname();

  db.collection("scores").doc(name).set({
    name: name,
    score: score,
    rank: rank,
    updated: firebase.firestore.FieldValue.serverTimestamp()
  });

  alert(`${score}%ï¼ˆ${rank}ï¼‰ã§é€ä¿¡ã—ã¾ã—ãŸ`);
}

/* =====================
   ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
===================== */
db.collection("scores")
  .orderBy("score", "desc")
  .limit(5)
  .onSnapshot(snapshot => {
    const ul = document.getElementById("ranking");
    ul.innerHTML = "";
    snapshot.forEach(doc => {
      const d = doc.data();
      const li = document.createElement("li");
      li.textContent = `${d.name}ï¼š${d.score}%ï¼ˆ${d.rank}ï¼‰`;
      ul.appendChild(li);
    });
  });
</script>

</body>
</html>
