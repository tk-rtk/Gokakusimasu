<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>合格を書いて競おう</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<style>
html, body {
  margin: 0;
  padding: 0;
  overflow: hidden;
  font-family: sans-serif;
  background: #f5f5f5;
  text-align: center;
}
canvas, img {
  width: 300px;
  height: 300px;
  background: #fff;
  border: 2px solid #000;
}
canvas { touch-action: none; }
.row {
  display: flex;
  justify-content: center;
  gap: 16px;
}
.hidden { display: none; }
button, select, input {
  font-size: 16px;
  margin: 6px;
  padding: 6px 10px;
}
#result {
  font-size: 20px;
  font-weight: bold;
  margin-top: 10px;
}
</style>
</head>

<body>

<h1>「合格」を書いてみよう</h1>

<div>
  難易度：
  <select id="difficulty">
    <option value="easy">EASY</option>
    <option value="normal" selected>NORMAL</option>
    <option value="hard">HARD</option>
  </select>
</div>

<!-- STEP1 -->
<div id="step1">
  <p>お手本をよく見て覚えてください</p>
  <div class="row">
    <img src="model_go.png">
    <img src="model_kaku.png">
  </div>
  <button onclick="toStep2()">書く</button>
</div>

<!-- STEP2 -->
<div id="step2" class="hidden">
  <p>お手本を見ずに書いてください</p>
  <div class="row">
    <canvas id="go" width="300" height="300"></canvas>
    <canvas id="kaku" width="300" height="300"></canvas>
  </div>
  <button onclick="judge()">判定</button>
  <button onclick="resetCanvas()">リセット</button>
</div>

<div id="result"></div>

<script>
/* ===== Canvas 描画 ===== */
function setupCanvas(canvas) {
  const ctx = canvas.getContext("2d");
  ctx.lineWidth = window.innerWidth < 600 ? 4 : 5;
  ctx.lineCap = "round";
  ctx.strokeStyle = "#000";
  let drawing = false;

  function pos(e) {
    const r = canvas.getBoundingClientRect();
    if (e.touches) {
      return {
        x: e.touches[0].clientX - r.left,
        y: e.touches[0].clientY - r.top
      };
    }
    return { x: e.offsetX, y: e.offsetY };
  }

  function start(e) {
    e.preventDefault();
    drawing = true;
    const p = pos(e);
    ctx.beginPath();
    ctx.moveTo(p.x, p.y);
  }
  function move(e) {
    e.preventDefault();
    if (!drawing) return;
    const p = pos(e);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
  }
  function end(e) {
    e.preventDefault();
    drawing = false;
  }

  canvas.addEventListener("mousedown", start);
  canvas.addEventListener("mousemove", move);
  canvas.addEventListener("mouseup", end);
  canvas.addEventListener("mouseleave", end);
  canvas.addEventListener("touchstart", start, { passive:false });
  canvas.addEventListener("touchmove", move, { passive:false });
  canvas.addEventListener("touchend", end, { passive:false });

  return ctx;
}

const goCtx = setupCanvas(document.getElementById("go"));
const kakuCtx = setupCanvas(document.getElementById("kaku"));

/* ===== 難易度 ===== */
function diff() {
  if (difficulty.value === "easy")
    return { overflow: 20, thick: 2.5, thickP: 15 };
  if (difficulty.value === "hard")
    return { overflow: 60, thick: 1.5, thickP: 40 };
  return { overflow: 40, thick: 1.8, thickP: 30 };
}

/* ===== 正規化（0点対策の核心） ===== */
function normalize(img) {
  for (let i = 0; i < img.data.length; i += 4) {
    const r = img.data[i];
    const g = img.data[i+1];
    const b = img.data[i+2];
    const brightness = (r + g + b) / 3;
    const bw = brightness < 245 ? 0 : 255;
    img.data[i] = img.data[i+1] = img.data[i+2] = bw;
  }
  return img;
}

/* ===== 採点 ===== */
function calcScore(ctx, modelSrc, cb) {
  const user = normalize(ctx.getImageData(0,0,300,300));
  const img = new Image();
  img.onload = () => {
    const c = document.createElement("canvas");
    c.width = c.height = 300;
    const t = c.getContext("2d");
    t.drawImage(img,0,0,300,300);
    const model = normalize(t.getImageData(0,0,300,300));

    let hit=0, miss=0, mc=0, uc=0;
    for (let i=0;i<model.data.length;i+=4) {
      const m = model.data[i] === 0;
      const u = user.data[i] === 0;
      if (m) mc++;
      if (u) uc++;
      if (m && u) hit++;
      if (!m && u) miss++;
    }

    if (mc === 0) {
      cb(0);
      return;
    }

    const s = diff();
    let score =
      hit/mc*100
      - miss/mc*s.overflow
      - Math.max(0, uc/mc - s.thick) * s.thickP;

    cb(Math.max(0, Math.min(100, Math.floor(score))));
  };
  img.src = modelSrc;
}

/* ===== 判定 ===== */
function judge() {
  calcScore(goCtx,"model_go.png",go=>{
    calcScore(kakuCtx,"model_kaku.png",ka=>{
      const avg = Math.floor((go + ka) / 2);
      const rank = avg>=95?"S":avg>=80?"A":avg>=65?"B":"C";
      result.innerHTML =
        `合：${go}%　格：${ka}%<br>平均：${avg}%　ランク：${rank}`;
    });
  });
}

function toStep2(){
  step1.classList.add("hidden");
  step2.classList.remove("hidden");
}
function resetCanvas(){
  goCtx.clearRect(0,0,300,300);
  kakuCtx.clearRect(0,0,300,300);
}
</script>

</body>
</html>
