<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>２０２６書き初めだ！「合格」の字を真似して、一字ずつ書いてみよう！</title>

<!-- スマホのズーム・スクロール抑制 -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    overflow: hidden; /* ← ページスクロール完全停止 */
    background: #f4f4f4;
    font-family: sans-serif;
    text-align: center;
  }

  h1 {
    margin: 16px 0;
  }

  .row {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin: 20px 0;
  }

  img, canvas {
    width: 300px;
    height: 300px;
    background: #fff;
    border: 2px solid #000;
  }

  canvas {
    touch-action: none; /* ← 超重要：指スクロール無効 */
  }

  button {
    padding: 10px 20px;
    font-size: 16px;
    margin: 8px;
  }

  #result {
    font-size: 22px;
    font-weight: bold;
    margin-top: 10px;
  }

  .hidden {
    display: none;
  }
</style>
</head>
<body>

<h1>「合格」を書いてみよう！</h1>

<!-- STEP1：お手本 -->
<div id="step1">
  <p>お手本をよく見て覚えましょう</p>
  <div class="row">
    <img src="model_go.png" alt="合 お手本">
    <img src="model_kaku.png" alt="格 お手本">
  </div>
  <button onclick="goToStep2()">書いてみる</button>
</div>

<!-- STEP2：書く -->
<div id="step2" class="hidden">
  <p>お手本を見ずに書いてください</p>
  <div class="row">
    <canvas id="go" width="300" height="300"></canvas>
    <canvas id="kaku" width="300" height="300"></canvas>
  </div>
  <button onclick="judge()">判定</button>
  <button onclick="resetCanvas()">リセット</button>
</div>

<div id="result"></div>

<script>
// =====================
// ステップ切り替え
// =====================
function goToStep2() {
  document.getElementById("step1").classList.add("hidden");
  document.getElementById("step2").classList.remove("hidden");
}

// =====================
// Canvas描画（スクロール完全防止）
// =====================
function setupCanvas(canvas) {
  const ctx = canvas.getContext("2d");
  ctx.lineWidth = 6;
  ctx.lineCap = "round";
  ctx.strokeStyle = "black";

  let drawing = false;

  function pos(e) {
    const r = canvas.getBoundingClientRect();
    if (e.touches) {
      return {
        x: e.touches[0].clientX - r.left,
        y: e.touches[0].clientY - r.top
      };
    }
    return { x: e.offsetX, y: e.offsetY };
  }

  function start(e) {
    e.preventDefault();
    drawing = true;
    const p = pos(e);
    ctx.beginPath();
    ctx.moveTo(p.x, p.y);
  }

  function move(e) {
    e.preventDefault();
    if (!drawing) return;
    const p = pos(e);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
  }

  function end(e) {
    e.preventDefault();
    drawing = false;
  }

  canvas.addEventListener("mousedown", start);
  canvas.addEventListener("mousemove", move);
  canvas.addEventListener("mouseup", end);
  canvas.addEventListener("mouseleave", end);

  canvas.addEventListener("touchstart", start, { passive: false });
  canvas.addEventListener("touchmove", move, { passive: false });
  canvas.addEventListener("touchend", end, { passive: false });

  return ctx;
}

const goCtx = setupCanvas(document.getElementById("go"));
const kakuCtx = setupCanvas(document.getElementById("kaku"));

// =====================
// 画像正規化
// =====================
function normalize(img) {
  for (let i = 0; i < img.data.length; i += 4) {
    const v = img.data[i];
    const bw = v < 200 ? 0 : 255;
    img.data[i] = img.data[i+1] = img.data[i+2] = bw;
  }
  return img;
}

// =====================
// スコア計算（画像ロード保証）
// =====================
function calcScore(ctx, modelSrc, callback) {
  const user = normalize(ctx.getImageData(0,0,300,300));

  const img = new Image();
  img.onload = () => {
    const tmp = document.createElement("canvas");
    tmp.width = 300;
    tmp.height = 300;
    const tctx = tmp.getContext("2d");
    tctx.drawImage(img, 0, 0, 300, 300);

    const model = normalize(tctx.getImageData(0,0,300,300));

    let hit = 0, total = 0;
    for (let i = 0; i < model.data.length; i += 4) {
      if (model.data[i] === 0) {
        total++;
        if (user.data[i] === 0) hit++;
      }
    }
    callback(Math.floor(hit / total * 100));
  };
  img.onerror = () => {
    alert("お手本画像が読み込めません。ファイル名を確認してください。");
  };
  img.src = modelSrc;
}

// =====================
// 判定＋ランク
// =====================
function judge() {
  calcScore(goCtx, "model_go.png", goScore => {
    calcScore(kakuCtx, "model_kaku.png", kakuScore => {
      const avg = Math.floor((goScore + kakuScore) / 2);

      let rank, color;
      if (avg >= 95) { rank = "S"; color = "gold"; }
      else if (avg >= 80) { rank = "A"; color = "green"; }
      else if (avg >= 65) { rank = "B"; color = "orange"; }
      else { rank = "C"; color = "red"; }

      const r = document.getElementById("result");
      r.innerHTML = `
        合：${goScore}% ／ 格：${kakuScore}%<br>
        平均：${avg}%<br>
        ランク：<span style="font-size:36px">${rank}</span>
      `;
      r.style.color = color;
    });
  });
}

// =====================
// リセット
// =====================
function resetCanvas() {
  goCtx.clearRect(0,0,300,300);
  kakuCtx.clearRect(0,0,300,300);
  document.getElementById("result").textContent = "";
}
</script>

</body>
</html>
