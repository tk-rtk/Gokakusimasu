<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>åˆæ ¼ã‚’æ›¸ã„ã¦ç«¶ãŠã†</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<!-- Firebase SDKï¼ˆscriptã‚¿ã‚°æ–¹å¼ï¼‰ -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  overflow: hidden;
  font-family: sans-serif;
  background: #f5f5f5;
  text-align: center;
}
canvas, img {
  width: 300px;
  height: 300px;
  border: 2px solid #000;
  background: #fff;
}
canvas {
  touch-action: none;
}
.row {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin: 10px 0;
}
.hidden { display: none; }
button {
  font-size: 16px;
  padding: 8px 16px;
  margin: 6px;
}
#result {
  font-size: 20px;
  font-weight: bold;
}
</style>
</head>

<body>

<h1>ã€Œåˆæ ¼ã€ã‚’æ›¸ã„ã¦ç«¶ãŠã†</h1>

<div>
  ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼š
  <input id="nickname" maxlength="10" placeholder="10æ–‡å­—ä»¥å†…">
</div>

<!-- STEP1ï¼šãŠæ‰‹æœ¬ -->
<div id="step1">
  <p>ãŠæ‰‹æœ¬ã‚’ã‚ˆãè¦‹ã¦è¦šãˆã¦ãã ã•ã„</p>
  <div class="row">
    <img src="model_go.png">
    <img src="model_kaku.png">
  </div>
  <button onclick="toStep2()">æ›¸ã</button>
</div>

<!-- STEP2ï¼šæç”» -->
<div id="step2" class="hidden">
  <p>ãŠæ‰‹æœ¬ã‚’è¦‹ãšã«æ›¸ã„ã¦ãã ã•ã„</p>
  <div class="row">
    <canvas id="go" width="300" height="300"></canvas>
    <canvas id="kaku" width="300" height="300"></canvas>
  </div>
  <button onclick="judge()">åˆ¤å®š</button>
  <button onclick="resetCanvas()">ãƒªã‚»ãƒƒãƒˆ</button>
</div>

<div id="result"></div>

<h2>ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚° TOP10</h2>
<ul id="ranking"></ul>

<script>
/* ================= Firebase ================= */
firebase.initializeApp({
  apiKey: "ã‚ãªãŸã®APIã‚­ãƒ¼",
  authDomain: "ã‚ãªãŸã®authDomain",
  projectId: "ã‚ãªãŸã®projectId"
});
const db = firebase.firestore();

/* ================= Canvas ================= */
function setupCanvas(canvas) {
  const ctx = canvas.getContext("2d");
  ctx.lineWidth = 6;
  ctx.lineCap = "round";
  ctx.strokeStyle = "#000";
  let draw = false;

  function pos(e) {
    const r = canvas.getBoundingClientRect();
    if (e.touches) {
      return {
        x: e.touches[0].clientX - r.left,
        y: e.touches[0].clientY - r.top
      };
    }
    return { x: e.offsetX, y: e.offsetY };
  }

  function start(e) {
    e.preventDefault();
    draw = true;
    const p = pos(e);
    ctx.beginPath();
    ctx.moveTo(p.x, p.y);
  }
  function move(e) {
    e.preventDefault();
    if (!draw) return;
    const p = pos(e);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
  }
  function end(e) {
    e.preventDefault();
    draw = false;
  }

  canvas.addEventListener("mousedown", start);
  canvas.addEventListener("mousemove", move);
  canvas.addEventListener("mouseup", end);
  canvas.addEventListener("mouseleave", end);
  canvas.addEventListener("touchstart", start, { passive:false });
  canvas.addEventListener("touchmove", move, { passive:false });
  canvas.addEventListener("touchend", end, { passive:false });

  return ctx;
}

const goCtx = setupCanvas(document.getElementById("go"));
const kakuCtx = setupCanvas(document.getElementById("kaku"));

/* ================= æ¡ç‚¹ ================= */
function normalize(img) {
  for (let i=0;i<img.data.length;i+=4) {
    const v = img.data[i];
    const bw = v < 200 ? 0 : 255;
    img.data[i]=img.data[i+1]=img.data[i+2]=bw;
  }
  return img;
}

function calcScore(ctx, modelSrc, cb) {
  const user = normalize(ctx.getImageData(0,0,300,300));
  const img = new Image();
  img.onload = () => {
    const c = document.createElement("canvas");
    c.width = c.height = 300;
    const t = c.getContext("2d");
    t.drawImage(img,0,0,300,300);
    const model = normalize(t.getImageData(0,0,300,300));

    let hit=0, miss=0, mc=0, uc=0;
    for (let i=0;i<model.data.length;i+=4) {
      const m = model.data[i]===0;
      const u = user.data[i]===0;
      if (m) mc++;
      if (u) uc++;
      if (m&&u) hit++;
      if (!m&&u) miss++;
    }

    let score = hit/mc*100 - miss/mc*80 - Math.max(0,uc/mc-1.3)*50;
    cb(Math.max(0,Math.min(100,Math.floor(score))));
  };
  img.src = modelSrc;
}

/* ================= åˆ¤å®š ================= */
function getName() {
  let n = document.getElementById("nickname").value.trim();
  if (!n) throw alert("ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  return n;
}

function judge() {
  calcScore(goCtx,"model_go.png",go=>{
    calcScore(kakuCtx,"model_kaku.png",ka=>{
      const avg = Math.floor((go+ka)/2);
      const rank = avg>=95?"S":avg>=80?"A":avg>=65?"B":"C";

      document.getElementById("result").innerHTML =
        `åˆ:${go}% æ ¼:${ka}%<br>å¹³å‡:${avg}% ãƒ©ãƒ³ã‚¯:${rank}`;

      db.collection("scores").add({
        name:getName(),
        score:avg,
        rank:rank,
        time:firebase.firestore.FieldValue.serverTimestamp()
      });
    });
  });
}

/* ================= ãƒ©ãƒ³ã‚­ãƒ³ã‚° ================= */
db.collection("scores")
  .orderBy("score","desc")
  .limit(10)
  .onSnapshot(s=>{
    const ul=document.getElementById("ranking");
    ul.innerHTML="";
    s.forEach(d=>{
      const x=d.data();
      const li=document.createElement("li");
      li.textContent=`${x.name}ï¼š${x.score}%ï¼ˆ${x.rank}ï¼‰`;
      ul.appendChild(li);
    });
  });

function toStep2(){
  step1.classList.add("hidden");
  step2.classList.remove("hidden");
}
function resetCanvas(){
  goCtx.clearRect(0,0,300,300);
  kakuCtx.clearRect(0,0,300,300);
}
</script>

</body>
</html>
